<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
div{
  display: inline-block;
}
div#scene{
  border: gray solid 1px;
  height:180px;
  width:320px;
}
</style>
<script>
const sig = String.fromCharCode(0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a);
const charEnd = String.fromCharCode(0xAD, 0x73, 0x6F, 0x6E, 0x44, 0x69, 0x72, 0x65, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x59, 0xCA, 0x00, 0x00, 0x00, 0x00);
let sceneSave;
let sceneImage;
let charaNum;
let charaData = [];
let sceneData;

function showChara(img) {
  var div = document.createElement('div');
  var input = document.createElement('input');
  input.type = "file";
  input.id = img.id.slice(0,-6);
  input.addEventListener( "change", changeEvent );
  div.appendChild(img);
  div.appendChild(document.createElement('br'));
  div.appendChild(input);
  document.getElementById('members').appendChild(div);
}

function addChara() {
  var img = document.createElement('img');
  img.id = charaData.length + 1 + "_image";
  img.src = "data:image/png;base64," + window.btoa(charaData[0]);
  showChara(img);
  charaNum ++;
  charaData.push(charaData[0]);
}

function remChara() {
  var ele =   document.getElementById("members");
  ele.removeChild(ele.lastElementChild);
  charaNum --;
  charaData.pop();
}

function loadScene(event) {
  var files;
  var reader = new FileReader();
  
  if(event.target.files){
    files = event.target.files;
    console.log(files[0].name);
  }else{ 
    files = event.dataTransfer.files;   
    console.log(files[0].name);
  }    
  reader.onload = function (event) {
    charaData = [];
    document.getElementById('save').removeAttribute("disabled");
    document.getElementById('add').removeAttribute("disabled");
    document.getElementById('rem').removeAttribute("disabled");
    document.getElementById('members').innerHTML = "";
    //PNGファイルシグネチャで分割
    var images = reader.result.split(sig);
    var img = document.createElement('img');
    //シーンの画像表示
    sceneImage = sig + images[1].slice(0,-4);
    charaNum = images.length - 2;
    img.id = "scene_image";
    img.src = "data:image/png;base64," + window.btoa(sceneImage);
    document.getElementById('scene').innerHTML = "";
    document.getElementById('scene').appendChild(img);
    
    for (var i = 2; i < images.length; i++) {
        var img = document.createElement('img');
        if(i == images.length - 1){
          //最後のキャラの場合末尾につくシーンデータを切り離す
          charaData[i-2] = sig + images[i].split(charEnd)[0] + charEnd;
          img.src = "data:image/png;base64," + window.btoa(charaData[i-2]);
          sceneData = images[i].split(charEnd)[1];
        } else {
          //最後尾以外のキャラはデータそのまま
          charaData[i-2] = sig + images[i];
          img.src = "data:image/png;base64," + window.btoa(charaData[i-2]);
        }
        
        img.id = i + "_image";
        //画像作成
        showChara(img);
    }
  }
  if (files[0]){    
    reader.readAsBinaryString(files[0]);
  }
}

var changeEvent = function charaChange(event) {
  var eventDOM = event.target;
  var files;
  var reader = new FileReader();
  
  if(event.target.files){
    files = event.target.files;
  }else{ 
    files = event.dataTransfer.files;   
  }
  reader.onload = function (event) {
    document.getElementById(eventDOM.id + "_image").src = "data:image/png;base64," + window.btoa(reader.result);
    charaData[eventDOM.id - 2] = reader.result;
  }
  if (files[0]){    
    reader.readAsBinaryString(files[0]); 
  }
}

function saveScene() {
  sceneSave = sceneImage;
  sceneSave += String.fromCharCode(charaNum, 0x00, 0x00, 0x00);
  for(var j=0; j < charaData.length; j++){
    sceneSave += charaData[j];
  }
  sceneSave += sceneData;
  var blob = new Blob([Uint8Array.from(sceneSave.split(""), e => e.charCodeAt(0))], {type: "image/png"});
  var a = document.createElement("a");
  var url = window.URL.createObjectURL(blob);
  a.href = url;
  a.download = "edited.png"; 
  a.click();
  window.URL.revokeObjectURL(url);
}
</script>  
</head>
<body>
  <button id="save" onclick="saveScene()" disabled="disabled">保存</button>
  <button id="add" onclick="addChara()" disabled="disabled">1人追加(先頭キャラを複製)</button>
  <button id="rem" onclick="remChara()" disabled="disabled">1人削除(末尾キャラを削除)</button>
  <br>
  <input type="file" id="inputfile" onchange="loadScene(event);"></input>
  <br>
  <div id="scene" ondrop="event.preventDefault();loadScene(event);" ondragover="event.preventDefault();">シーンデータをドロップ</div>
  <br>
  <div id="members"></div>
</body>
</html>
